# Chapter 18. 깃옵스와 배포

## 깃옵스란?

깃 리포지터리를 SSOT로 하여 모든 클러스터 리소스가 깃으로 동기화된다.

- 멀티클러스터를 일관성 있게 관리하고 클러스터 전체적으로 구성 드리프트를 방지할 수 있다.
- 또 여러 환경별 클러스터를 선언형으로 기술하고, 이렇게 기술된 상태로 실제 클러스터의 상태를 유지할 수 있다.

4대 원칙 :

- 선언형 구성
- 구성 버저닝
- 불변 구성
- 지속적인 상태 조정

## 깃옵스가 필요한 이유

클러스터를 관리하는 뛰어난 수단이다.

사람이 직접 하지 않음

## 깃옵스 리포지터리 구조

- 단일 리포지터리
- 팀별 레포지터리
- 애플리케이션 리포지터리
- 환경별 브랜치

잘 모르겠으면 팀별 리포지터리부터 시작하자.

## 시크릿 관리

- 깃에 직접 시크릿을 저장 -> 최악
- 컨테이너 이미지에 시크릿 집어넣기 -> 로테이션 어떻게..?
- 쿠버네티스 시크릿 사용 -> 쿠버네티스 시크릿은 BASE64 인코딩
- 실드 시크릿(Selaed Secret) 사용
- 시크릿 관리 툴에 시크릿을 저장 : KMS

# Chapter 19. 보안

레이어 별로 여러 겹의 보안 장치를 강구하여 쿠버네티스와 워크로드를 보호하는 '심층 방어' 전략이다. + 최소 권한 원칙

## 클러스터 보안

### etcd 액세스

디폴트 스토리지 시스템. 오직 k8s API 서버만 etcd에 접근 가능해야 한다.

### 인증

Bearer Token, Cert, OIDC, LDAP 등 다양한 인증 수단 제공

보안 문제는 kubeconfig 파일을 생성, 배포, 저장할 때 불거지는 경우가 많음. 인증 프로바이더를 사용하자.

### 인가

RBAC으로 최소한의 작업만 액세스 시키자.

### TLS

TLS 보안이 적용된 API 엔드포인트를 기본 제공한다. 인증서의 수명을 짧게 설정하고 자주 교체하거나, 수동 교체할 수 있어야 한다.

### kubelet과 클라우드 메타데이터 액세스

kubelet은 기본적으로 미인증 API가 활성화되어 있으므로, 인증/인가를 활성화하자.

### 시크릿

csi-secret-store 같은 걸 사용할 수도

### 로깅과 감사

감사 로깅을 활성화하고, 집계 지점으로 보내 경고를 받자

### 클러스터 보안 태세 툴

Kubescape 같은 툴을 사용해보자

## 워크로드 컨테이너 보안

### 파드 시큐리티 어드미션

파드 구성 시 보안에 민감한 모든 컴포넌트를 구성/관리하고 네임스페이스나 클러스터 수준에서 즉시 활용 가능한 모범 사례를 적용할 수 있다.

### Seccomp, AppArmor, SELinux

Seccomp : 컨테이너에서 유입된 시스템 호출을 제한하는
AppArmor, SELinux 컨테이너별로 꼭 필요한 액세스 제어를 세밀하게.

### 어드미션 컨트롤러

보안 관련 어드미션 컨트롤러는 모두 기본적으로 활성화

### 오퍼레이터

오퍼레이터의 RBAC이 편의상 관대한 구성을 제공함.

간혹 권한 상승으로 이어지는 통로가 될 때가 있음

### 네트워크 정책

### 런타임 보안

Kata conatiner, gviosr 등을 고려할 수도 있음

Confidential container를 사용할 수도 있음.

Falco를 활용해서 컨테이너 런타임 안에서 애플리케이션이 할 수 있는 작업에 대해 감사 로깅 및 정책을 활성화할 수 있다.

## 코드 보안

- non-root, 무배포 컨테이너(scratch container)
- 컨테이너 취약점 탐색
- 코드 리포지터리 보안 (OpenSSF)
