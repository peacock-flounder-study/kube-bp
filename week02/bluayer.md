# Chapter 03. 모니터링과 로깅
## 메트릭 vs 로그

상호 보완적이지만 용도가 다르다.

- 메트릭 : 정해진 기간에 측정한 수치
- 로그 : 에러, 경고, 중요 이벤트 등 프로그램 실행 중 일어난 사건을 추적

## 모니터링 기법

Closed-box Monitoring : 애플리케이션 외부에서 모니터링 (CPU, Memory, Storage)
Open-box Monitoring : 총 HTTP 요청 수, 500 에러 횟수, 요청 레이턴시 같은 애플리케이션 상태에 주목

## 모니터링 패턴

24/7 가동되는 VM은 모든 상태가 보존되는지 확인하는 식으로 모니터링하지만, k8s는 수명이 짧고 다이내믹한 파드의 특성을 잘 나타낼 수 있는 모니터링 체계가 필요하다.

1. USE method : 사용률(Utilization), 포화도(Saturation), 에러 수(Errors) -> 주로 인프라 수준
2. RED 방법론 : 처리율(Rate), 에러 수(Errors), 처리 시간(Duration) -> 애플리케이션의 엔드 유저 경험 위주

두 방법론은 서로 상호 보완적

## 쿠버네티스 메트릭 개요

컨트롤 플레인 : API 서버, etcd, 스케줄러, 컨트롤러 매니저
노드 : kubelet, 컨테이너 런타임, kube-proxy, kube-dns, 파드

클러스터와 애플리케이션의 정상 가동 -> 모든 컴포넌트를 빠짐없이 모니터링

### cAdvisor

Container Advisor(cAdvisor)는 노드에서 실행 중인 컨테이너의 리소스와 메트릭 수집

k8s kubelet과 한 몸으로 클러스터의 모든 노드에서 실행됨.

cgroup 트리를 통해 메모리, CPU 메트릭을 수집하며, 리눅스 커널에 내장된 statfs로 디스크 메트릭을 수집한다.

**모든 컨테이너 메트릭의 SSOT**

### 메트릭 서버

1. Metric Server는 resource metric API의 표준 구현체로, 리소스 메트릭을 kubelet API에서 수집해서 메모리에 저장한다. 수집된 메트릭은 스케줄러, HPA, VPA에서 사용된다.
2. Custom metric API를 사용하면 임의의 메트릭을 수집할 수 있고 확장할 수 있다. 프로메테우스는 커스텀 메트릭 기반의 HPA를 사용할 수 있는 최초의 커스텀 메트릭 어댑터다.

### kube-state-metrics

k8s에 저장된 오브젝트를 모니터링하는 k8s add-on

클러스터에 배포된 k8s 오브젝트의 상태 파악이 주된 관심사다.

***예시***

- 파드
  - 클러스터에 파드가 몇 개 배포되었나?
  - 대기 상태인 파드는 몇 개인가?
- 디플로이먼트
  - 실행 중인 파드 대비 몇 개의 파드가 의도한 상태인가?
  - 레플리카는 몇 개 사용할 수 있나?
  - 어떤 디플로이먼트가 업데이트되었나?
- 노드
  - 내 노드의 상태는 어떠한가?
  - 클러스터에 할당 가능한 CPU 코어 수는 몇 개인가?
  - 스케줄링 불가능한 노드가 있는가?

꽤 많은 오브젝트 타입을 추적함

## 어떤 메트릭을 모니터링하나?

다음의 요소를 계층적으로 접근하기
- 물리 또는 가상 노드 (CPU, Memory..)
- 클러스터 컴포넌트 (etcd 레이턴시)
- 클러스터 애드온 (클러스터 오토스케일러, 인그레스 컨트롤러)
- 엔드 유저 애플리케이션

예시 : 어떤 파드가 자꾸 대기 상태에 빠질 경우, 일단 노드의 리소스 사용률을 체크하고 문제가 없으면 클러스터 수준의 컴포넌트를 타깃팅하는 식으로 살펴보기

## 모니터링 툴

- 프로메테우스
- InfluxDB
- Datadog
- Sysdig Monitor
- CSP 툴들
