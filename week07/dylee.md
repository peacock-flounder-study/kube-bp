# 14. 쿠버네티스에서 머신러닝 실행하기
## 1. 머신러닝에 쿠버네티스를 사용하면 좋은 점

- 쿠버네티스의 특성인 보편성, 스케일링, 확장성, 셀프 서비스, 이식성 덕분에 어떤 환경에서도 편리하게 모델을 실행시킬 수 있다

## 2. 머신러닝 워크플로

1. 데이터셋 준비
    - 모델 훈련용 데이터셋을 저장하고, storage interface 또는 api를 통해 접근 가능한 저장소가 필요
2. 모델 개발&훈련
    - k8s의 스케줄링, 특수 하드웨어 액세스, 데이터셋 볼륨 관리, 스케일링, 네트워킹 등의 태스크로 모델 훈련
3. 제공

## 3. 고려 사항

### 1. 모델 훈련

- 모델 훈련 시 하이퍼퍼라미터 튜닝을 사용 → 이 방식은 병렬 처리에 유리하므로 → 훈련 전 4~8개의 GPU를 탑재한 VM을 준비해 두자
- 모델 훈련 과정
    1. cluster에 gpu가 있는지 확인
    2. Job으로 배치성 workflow를 작성해 모델 훈련 진행

### 2. 분산 훈련

- 분산 훈련 최적화는 어렵지만 → 필요하다면 분산 아키텍처를 이해하고, 사용하자

### 3. 리소스 제약조건

- 리소스를 높이면, 훈련 job이 더 빨리 끝나지만 스케일링은 병목을 수반함 → 적절한 제약 조건을 설정해서 모델을 학습시키자

### 4. 특수 하드웨어

- 모델 훈련은 GPU 같은 특수 하드웨어에서 수행하는 것이 효율적이다

### 5. 라이브러리, 드라이버, 커널 모듈

- 특수 하드웨어에 액세스 하려면 전용 라이브러리, 드라이버, 커널 모듈들이 컨테이너 런타임에 마운트 또는 어드미션 웹훅이 필요하다

### 6. 스토리지

- 모델 훈련 중 모든 노드에서 데이터셋을 가져올 수 있어야 한다
- 모델 훈련 진행 시 체크포인트가 생성되는데, 이때 저장 모델을 체크포인트를 제공하는 용도로 사용할 수 있다

### 7. 네트워킹

- tensorflow의 분산 아키텍처에서는 각 파라미터 서버에서 각 노드로 가변 분산을 하는 단계와 각 노드에서 파라미터 서버로 다시 되돌아가는 도중에 네트워크 트래픽이 몰림 → 이 시간이 모델 훈련의 소요 시간을 결정하므로 적절한 네트워크 대역폭을 적용하자!

### 8. 전용 프로토콜

- MPI: 분산 프로세스 간 데이터 전송을 위한 표준 API
- NCLL: 토폴로지 인식 멀티 GPU 통신 프리미티브 라이브러리

# 15. 고수준 애플리케이션 패턴 구축

## 1. 고수준 추상화 개발 방식

- 쿠버네티스에서 고수준의 primitive를 개발하는 방법?
    - 쿠버네티스를 implementation detail로 wrapping하기
    - 쿠버네티스 자체에 확장 기능을 내장시켜 사용하기
        - 쿠버네티스 서버 API는 유연하기 때문에 새로운 리소스를 자유롭게 추가할 수 있다!
- 상황에 따라 적절하게 추상화를 적용하자
    - 만약 사용 편의성이 더 중요하다면, 완전 격리된 환경을 구축하자

## 2. 쿠버네티스 확장

### 1. 쿠버네티스 클러스터 확장

- 쿠버네티스 리소스가 맞물리는 접점인 pain point를 확인하자
1. sidecar
- service mesh에  sidecar를 붙여 메인 어플리케이션에서 분리된 부가 기능을 제공하자
1. admission controller
- 클러스터 기반 저장소에 저장되기 전에 쿠버네티스 api 요청을 읽어들이는 인터셉터
- sidecar를 자동으로 추가할 수 있고, 오브젝트 유효성을 검사할 수 있다

### 2. 쿠버네티스 UX 확장

- kubectl 플러그인을 이용해 쿠버네티스에 ux를 확장해 새로운 기능을 제공하자

### 3. 컨테이너화 개발 간소화

- 애플리케이션 컨테이너화를 자동화해주는 도구를 활용해 애플리케이션 컨테이너화를 간소화 하자

### 4. push to deploy 환경 구축

- github actions + git ops로 git repo에 코드를 Push하면 테스트, 빌드, 컨테이너 이미지 패키징이 자동으로 수행되는 환경을 구축하자

## 3. 플랫폼 구축 시 설계 고려 사항

### 1. 컨테이너 이미지로 export 하는 기능 지원

- 애플리케이션 자동 컨테이너화를 구성해서 애플리케이션의 현재 이미지만 export 해서 플랫폼을 구축할 수 있도록 하자

### 2. 기존 서비스와 서비스 디스커버리 매커니즘 지원

- 쿠버네티스에서 제공하는 DNS 기능을 이용해서 상이한 플랫폼들끼리 연결하자
