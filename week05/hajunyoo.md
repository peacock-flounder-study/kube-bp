## 9장. 네트워킹, 네트워크 보안 및 서비스 메시

Kubernetes는 연결된 시스템 클러스터 전반에서 분산 시스템의 관리자 역할을 하므로, 연결된 시스템들이 서로 통신하는 방식, 즉 네트워킹이 매우 중요. 

서비스 간 통신을 효과적으로 적용하기 위해서는 Kubernetes가 분산 서비스 간의 통신을 촉진하는 방법을 이해하는 것이 필수적.

### I. Kubernetes 네트워크 원칙

Kubernetes가 기본 네트워크를 사용하여 서비스 간의 통신을 촉진하는 방법을 이해하는 것

→ 애플리케이션 아키텍처를 효과적으로 계획하는 데 중요하다고 함

1. **동일한 포드 내 컨테이너 간 통신**
    - **동일한 파드**에 있는 모든 컨테이너는 동일한 네트워크 공간을 공유.
    - 이는 컨테이너 간의 **로컬 호스트 통신**을 효과적으로 허용.
    - 따라서 동일한 파드의 컨테이너들은 서로 다른 포트를 노출해야 함.
2. **포드 간 통신**
    - 모든 파드(Pods)는 **NAT(네트워크 주소 변환) 없이 서로 통신**해야 함
    - 수신 파드에 표시되는 파드의 IP 주소는 발신자의 실제 IP 주소.
    - 이 규칙은 같은 노드에 있는 파드와 같은 클러스터의 다른 노드에 있는 파드 간에 모두 적용됨.
3. **서비스 간 커뮤니케이션**
    - 서비스는 각 노드에서 발견되는 **내구성 있는 IP 주소와 포트**를 나타내며, 서비스에 매핑된 엔드포인트로 모든 트래픽을 전달
    - 이를 활성화하는 두 가지 주요 방법은 **`iptables`** 또는 최신 IP 가상 서버(IPVS)를 사용하는 것.
    - 오늘날 대부분의 구현은 각 노드에서 의사 계층 4 로드 밸런서를 활성화하기 위해 `iptables` 구현을 사용

### II. 네트워크 플러그인 (Kubenet 및 CNI)

Kubernetes 네트워킹 표준은 third party 네트워킹 프로젝트를 허용하는 plugin 가능한 아키텍처로 발전.

1. **Kubenet**
    - Kubernetes에서 기본으로 제공되는 **가장 기본적인 네트워크 플러그인**
    - Kubenet은 연결된 파드를 위한 가상 이더넷 쌍인 Linux bridge(`cbr0`)를 제공
    - 파드는 클러스터 노드에 분산된 CIDR(class-less 도메인 간 라우팅) 범위에서 IP 주소를 얻음
    - **파드 간 통신 규칙을 준수**하며, 파드 CIDR 외부로 향하는 트래픽만 NAT를 거치도록 설정해야 함.
    - **Kubenet 모범 사례:**
        - 단순한 네트워크 스택을 허용하고 혼잡한 네트워크에서 귀중한 IP 주소를 사용하지 X
        - 클러스터의 잠재적 크기와 각 클러스터의 파드를 처리할 수 있을 만큼 포드 CIDR 범위가 충분히 큰지 확인 필요
2. **CNI (컨테이너 네트워크 인터페이스) - 중요**
    - 컨테이너를 위한 일반 플러그인 네트워크 솔루션인 CNI 사양을 따르는 플러그인 유형.
    - CNI는 제공하는 인터페이스, 최소한의 API 동작, 그리고 컨테이너 런타임과 인터페이스하는 방법을 규정해야 함
    - 네트워크 관리 구성 요소는 **IP 주소 관리**를 포함해야 하며, 최소한 네트워크에 컨테이너를 추가 및 삭제할 수 있어야 함
    - **CNI 플러그인 예시:** Microsoft Azure 네이티브 CNI, AWS VPC CNI 플러그인과 같은 클라우드 공급자 플러그인뿐만 아니라 Nuage CNI, VMware NSX와 같은 기존 네트워크 공급자의 플러그인도 있음
    - **CNI 모범 사례:**
        - 인프라의 전반적인 네트워킹 목표를 달성하는 데 필요한 기능 세트(고가용성, 멀티클라우드 연결, 네트워크 정책 지원 등)를 평가해야 함
        - 퍼블릭 클라우드를 사용할 경우 해당 클라우드 제공업체의 SDN에 기본 제공되지 않는 CNI 플러그인이 실제로 지원되는지 확인해야 함
        - 네트워크 보안 도구 및 통합 가시성 도구(예: 위브웍스 위브 스코프, 다이나트레이스)가 선택한 CNI 플러그인과 호환되는지 확인해야 함


-----------

### I. 파드 보안 어드미션 컨트롤러 (Pod Security Admission Controller)

파드 보안 어드미션 컨트롤러는 클러스터 전체 리소스로서, 파드 사양 내의 모든 보안에 민감한 필드를 정의하고 관리할 수 있는 단일 장소를 제공

1. 등장 배경 및 특징

- 이 컨트롤러는 **파드시큐리티폴리시 (PodSecurityPolicy, PSP)** API를 대체하기 위해 개발됨. PSP는 복잡하고 올바르게 설정하기 어려움
- 파드 시큐리티 어드미션 컨트롤러는 이러한 복잡성을 해결하고 클러스터의 파드 보안을 매우 간단하게 보호할 수 있도록 개발됨.
- **참고:** 파드 시큐리티 어드미션 컨트롤러는 Kubernetes 1.22부터 베타로 PSP를 대체했으며, PSP는 Kubernetes 1.25에서 제거됨.
- PSA는 파드 보안을 위한 간소화된 API를 제공하지만, PSP와의 완전한 기능 동등성은 제공 X.
    - 더 완벽한 정책 솔루션이 필요하다면 게이트키퍼(Gatekeeper) 프로젝트와 같은 솔루션 설치 필요
- PSA는 **네임스페이스 수준**에서 적용되는 세분화된 권한이라는 상당한 제한이 존재.
    - 이 제한 때문에 멀티-테넌트 클러스터를 운영하는 관리자는 게이트키퍼와 같은 정책 솔루션을 구현해야 할 가능성이 높음

2. 활성화 및 주의 사항

- 클러스터가 Kubernetes 1.22 이상이라면, 파드 보안 어드미션이 활성화되어 있을 가능성이 높음. 이전 버전 사용자는 보안 취약점 위험 때문에 업데이트하는 것이 좋음
- **경고:** 기존 클러스터에서 PSA를 활성화할 때는 적절한 준비 없이 진행하면 워크로드가 차단될 수 있으므로 주의. **`warn`** 및 **`audit`** 적용 모드로 시작하여 정책이 예상대로 작동하는지 확인하는 것이 좋음.

3. 파드 보안 표준 레벨 (Pod Security Levels)

PSA 컨트롤러는 관리자가 선택할 수 있는 세 가지 정책 레벨을 구현하여 보안 구성을 간소화.

- **`privileged`:** 사실상 제한이 없으며, 파드 보안이 활성화되지 않은 Kubernetes 클러스터의 기본 동작과 일치
- **`baseline`:** 알려진 권한 상승 및 기타 보안 문제로부터 보호
- **`restricted`:** 가장 제한적인 레벨.
    - 이 레벨은 클러스터의 기존 구성이 손상되거나 타사 커뮤니티 솔루션이 제대로 작동하지 않을 수 있다는 점에 유의 필요

4. 정책 활성화 기능 (Enforcement Modes)

PSA는 정책에 대해 세 가지 레벨의 활성화 기능을 제공

- **`enforce`:** 보안 레벨과 일치하지 않는 경우 파드가 생성되는 것을 **적극적으로 차단**
- **`warn`:** 파드가 정책을 위반한다는 **경고**를 사용자에게 제공하지만, 파드 생성을 차단하지는 않음. (참고: `kubectl`과 같이 경고를 지원하는 도구에서만 경고가 표시되며, CI/CD 자동화에서는 표시 X
- **`audit`:** 정책 위반을 **기록**하지만 사용자 피드백은 제공 X

5. 버전 관리 및 모범 사례

- 각 보안 수준은 특정 Kubernetes 버전 (예: `v1.25`)과 일치하도록 버전이 지정되지만, 다른 Kubernetes 버전에서도 사용 가능
- **`latest`** 버전을 사용하는 것은 클러스터가 업그레이드될 때 정책이 변경되어 예기치 않게 클러스터가 중단될 수 있으므로 **권장 X**
- **모범 사례:** 클러스터 업그레이드 후 보안 정책을 **점진적으로 업그레이드**하는 것이 좋다고 함

6. 네임스페이스 레이블을 통한 활성화

파드 시큐리티는 네임스페이스에 레이블을 추가하여 네임스페이스별로 활성화.

- **예시 (감사 및 경고 활성화):** 초기에는 `enforce: privileged`로 설정하고 `audit`을 `baseline`으로 설정하여 기존 사용을 감사하는 구성으로 시작 가능
    
    ```
          pod-security.kubernetes.io/enforce: privileged
          pod-security.kubernetes.io/enforce-version: v1.25
          pod-security.kubernetes.io/warn: privileged
          pod-security.kubernetes.io/warn-version: v1.25
          pod-security.kubernetes.io/audit: baseline
          pod-security.kubernetes.io/audit-version: v1.25
    
    ```
    
- **권장 시작점:** 대부분의 사용자에게는 **`audit` 및 `warn`을 `restricted`으로, `enforce`를 `baseline`으로 설정**하는 것이 좋은 시작점이 될 수 있음. 이는 가장 심각한 위반을 방지하면서 취약한 구성에 대한 가시성을 확보할 수 있게 함