# 20. 카오스 테스팅, 로드 테스팅, 실험

## 1. 카오스 테스팅

- edge condition(에러 + 극악의 환경)을 애플리케이션에 대입해 반응을 확인해서 애플리케이션의 회복 탄력성을 알아보는 테스트 기법
- 테스팅 전, 애플리케이션의 environment condition을 이해한 후 실제와 가까운 edge condition을 선정하자
- 모니터링, 로깅 미리 구축한 다음 테스트를 진행하기

### 애플리케이션 통신에 관한 카오스 테스팅

- proxy를 통해 애플리케이션의 통신에 카오스를 주입해 테스트를 진행하자
    - ToxiProxy가 제일 유명
    - 클라이언트 → ToxiProxy → backend 구조를 구축하기 위해 ToxyProxyPod를 가리키는 새 서비스를 생성하고, 기존 백엔드 서비스로 가던 요청을 toxi proxy로 라우팅

### 애플리케이션 작동에 관한 카오스 테스팅

- pods를 삭제하는 script를 작성하거나, k8s client, Chaos Mesh 등을 이용해 애플리케이션이 실행되는 인프라가 불안하거나, 과부화 걸린 상황에 대한 테스트를 진행하자
- 인프라 전체 장애를 테스팅 할 때는
    - 클라우드 환경 → VM API로 클러스터의 머신 shutdown, rebooting
    - 물리적 환경 → 전원 뽑기 or 리부팅

### 애플리케이션의 보안 및 복원성에 관한 fuzz testing

- 극단적인 입력을 받아도 애플리케이션이 잘 대처하는지 테스트 하는 기법

## 2. 로드 테스팅

- 애플리케이션에 부하(실제 프로덕션 사용량 정도의 트래픽)를 주면 어떻게 동작하는지 확인하는 테스트 과정

### 1. 로드 테스팅의 목표

- 새 버전의 소프트웨어가 이전 버전처럼 동일한 부하를 견딜 수 있는지 테스트 후 새로운 이슈를 파악하자
- 과거 추이를 바탕으로 사용량 예측한 다음, 부하를 줘서 동작을 확인한 후 인프라 환경을 개선하자

### 2. 로드 테스팅의 전제 조건

- 로깅, 모니터링, 실제와 가까운 부하 생성

### 3. 실제와 가까운 트래픽 생성

- 서비스가 사용되는 방식을 파악해 현실과 가까운 가상 부하를 만들자

### 4. 애플리케이션 로드 테스팅

- 애플리케이션 사본을 만들어서 테스트를 진행하자
    - 동일 cluster에서 테스트 실행 시 → edge load balancer를 실행해 트래픽을 분산시켜 테스트 진행
    - JMeber, Locust를 이용해 분산 로드 테스팅을 많이 진행함

### 5. 로드 테스팅을 이용한 애플리케이션 튜닝

- 로드 테스팅을 통해 가장 효율적인 파드, 코어, 메모리를 찾아내자

  # 21. 오퍼레이터 구현

  ## 1. 오퍼레이터 핵심 컴포넌트

- 체계적인 SDK, 라이프사이클 관리, 퍼블리싱 도구가 탑재된 오픈소스 툴킷

## 2. 커스텀 리소스 정의

- CRD를 사용하면 애플리케이션의 리소스 요건을 선언형으로 더 잘 표현할 수 있다

### 1. 쿠버네티스 API 오브젝트, 리소스, 버전, 그룹 및 카인드

- 쿠버네티스 오브젝트: pod, pvc 상태로 존재하는 리소스 정의
- 쿠버네티스 리소스: 특정 카인드의 오브젝트 컬렉션을 나타내는 api endpoint
- 쿠버네티스 api도 버저닝 지원 → 버저닝 가이드라인을 준수하기
- 카인드: 카인드의 구현체가 리소스(카인드:리소스 = 1:1)

## 3. API 생성

- CRD는 kubebuilder과 operator SDK를 이용해 생성하도록 하자

## 4. 컨트롤러 조정

- 오퍼레이터는 지정한 리소스 타입에 관한 이벤트를 감시 → 이벤트(프레디킷)발생 시 오퍼레이터가 의도한 상태를 실행 중인 상태로 조정하는 프로세스 시작

## 5. 리소스 검사

- 요청된 리소스가 유효한지 검사하는 작업은 오퍼레이터의 설계 측면에서 중요하다 → 일관된 동작을 유지하기 위해 리던던시를 구축하자

## 6. 오퍼레이터 라이프 사이클

- 여러 차례 개선을 통해 오퍼레이터의 기능을 개선하자
