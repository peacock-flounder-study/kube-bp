# Chapter 07. 글로벌 애플리케이션 분산과 스테이징

## 이미지 분산 배포

이미지 레지스트리에 자동 지리 복제(automatic geo-replication)

- Image Pull Latency : 머신 자체가 잘못되면 다시 풀링해야 하기 때문에 장애 대응 시간에 영향
- SPoF : 레지스트리가 한 곳에만 있다면?

리전 서버 vs 네트워크 구성을 통해 DNS로 각지를 연결 (리전 서버가 더 간편)

## 배포 파라미터화

템플릿 기반 - 헬름

## 글로벌 트래픽 로드 밸런싱

geo proximity가 바람직하지만, 여러 리전에 걸쳐 failover하는게 좋다.

멀티캐스트 IP

## 안정적인 글로벌 롤아웃

글로벌 롤아웃 : 문제를 어떻게 빨리 감지할지, 신속하게 소프트웨어 롤아웃을 할지, feature flag

### 카나리 리전

테스팅이 모든 걸 걸러주진 않음 - 실패할 것은 언젠가 실패한다.

카나리 리전에서 몇 일동안 테스팅 후 타 리전에 배포할 것

### 리전 타입 식별

모바일 트래픽이 많은지, locale 등

### 글로벌 롤아웃

프로덕션 리전 롤아웃 후 다음 리전까지 얼마의 시간? - 과거에 문제가 불거질 때까지 소요된 평균 시간의 2배 정도를 기다리자

트래픽 적은 리전에 롤아웃 -> 많은 리전에 롤아웃해서 릴리스 품질에 대한 믿을 갖자

## 문제 발생 시 대처 요령

체크리스트 + 사전 모의 장애 훈련(트래픽 쉬프팅, 데이터 복구)

# Chapter 08. 리소스 관리

## 쿠버네티스 스케줄러

Predicate & Scoring algorithm

### Predicate

결정하는 첫 번째 함수. true/false를 반환하는 hard constraint

restrictiveness와 complexity 순서로 체크

### 우선순위

노드를 스케줄링에 배제했다면, 상대적인 값에 따라 노드의 우선순위가 매겨짐. (더 리소스가 여유있는)
우선순위가 동일하다면 라운드로빈

## 고급 스케줄링 기법

리소스 스케줄링 로직을 조정 - 모든 AZ에 파드 스케줄링 등

### 파드 어피니티와 안티 어피니티

파드를 어디에 배치할지, 어디에 배치하지 않을지(같이 배치하지 않게 등)

### 노드 셀렉터

가장 쉬운 방법. 

셀렉터 : 노드를 request 테인트 : 노드를 reserve (노드에 스케줄링되지 않도록 파드를 내쫓는 역할)

둘을 함께 사용하면, GPU 워크로드 전용 노드를 예약하면서, GPU가 장착된 하드웨어의 노드를 자동 선택할 수 있음

### 테인트

특수 하드웨어(GPU) / 전용 노드 리소스 / 성능 저하 노드 배제

- NoSchedule
- PreferNoSchedule
- NoExecute
- NodeCondition

## 파드 리소스 관리

리소스에 맞는 노드가 없으면 펜딩됨 -> 카펜터나 CAS 같은 걸로 노드 확장이 트리거링 되고 파드 스케줄링할 수 있게 됨

### 리밋

CPU 초과 : CPU 사용 못하게 스로틀링
메모리 리밋을 초과하면 파드를 동일 노드나 아예 다른 호스트에서 재시작

파드가 생성되면 QoS가 할당됨
- Guaranted : CPU, Memory Request == Limit
- Bustable : Limit > Requezt
- Best Effort : 지정 X

### PodDisruptionBudgets

CAS가 노드 할당  해제, 파드 템플릿 업데이트할 때 involuntary evition이 일어날 수 있음.

애플리케이션 영향도 최소화를 위해 해당 버짓을 설정하여 애플리케이션 가동 시간을 보장

minAvailable : 최소 가용 파드 수
maxUnavailable : 최대 불용 파드 수 (아무리 많아도 N%만 eviction), %는 모호함(일반적으로 반올림)

### 네임스페이스를 활용한 리소스 관리

네임스페이스 설계를 잘하고, 리소스 쿼터, RBAC 등의 단위로 잘 나누자.

default/kube-system ns는 가급적 사용하지 말자. 

**kubens, kubectx** 같은 도구를 활용하기

### 리소스쿼터

여러 팀이 한 클러스터 사용한다면, 네임스페이스에 ResourceQuota를 부여 해야 한다.

### 리밋레인지

리소스쿼타를 사용한다면 리밋 레인지 필수

