# 05. 지속적 통합, 테스팅, 배포

### 버전 관리
- 모든 파이프라인의 시작은 깃 기반 버전 관리
- main 브랜치에 최종 코드, 기능은 별도 브랜치에서 작업 후 머지.
- 애플리케이션 코드 + 구성 코드(매니페스트, 헬름 차트) 함께 관리 → 개발·운영 간 협업 강화.

### 지속적 통합(CI)
- 작은 단위의 코드 변경을 자주 커밋 → 즉시 빌드 및 피드백.
- 젠킨스 등 CI 툴 활용, 운영팀도 코드/워크플로에 익숙해져야 함.

### 테스팅
- 파이프라인에서 자동화 테스트 수행 → 잘못된 코드 프로덕션 진입 차단
- 단위 테스트, 헬름 lint, 스모크 테스트 등 다양한 수준 필요.
- 팀 간 협업 전제로 엔드-투-엔드 파이프라인 구축 중요.

### 컨테이너 빌드
- 이미지 최적화 필수 (작을수록 배포 빠르고 보안 ↑).
- 방법: 멀티스테이지 빌드 / 무배포(distroless) / 슬림 베이스 이미지.
- 컨테이너 환경에 익숙해질수록 무배포 이미지 활용도가 높아짐.

### 컨테이너 이미지 태깅
- latest는 이미지 태그로 절대 사용 금지. latest는 버전이 아님. 이미지에 어떤 코드 변경 내용이 포함됐는지 알 수 없음
- 빌드 ID, 시스템-빌드 ID, 깃 해시, 깃 해시+빌드 ID 등 고유 태그 사용

### 지속적 배포(CD)

- CI 통과한 변경분을 자동으로 프로덕션까지 배포.
- 컨테이너는 일관된 환경 보장 → 구성 드리프트 문제 해결.
- CD 전에 탄탄한 CI + 테스트 세트 먼저 마련하기 

### 배포 전략
- 쿠버네티스 지원 롤아웃 방식

  - 롤링 업데이트 (기본, 무중단)
  - 블루/그린 배포
  - 카나리 배포


# 06. 버저닝, 릴리스, 롤아웃

### 6.1 버저닝
- 모놀리식의 문제: 비대해져 업그레이드/버저닝 어려움 → 마이크로서비스와 애자일로 전환.
- 컨테이너는 격리·조합성에 강점, 그러나 대규모 운영엔 자동화 필요.
- 오케스트레이터(Kubernetes, Mesos, Nomad, Swarm .. 등) → 버저닝·릴리스·배포 기본 제공
- 시맨틱 버저닝: `메이저.마이너.패치`
  - 패치: 버그 수정, API 변경 없음
  - 마이너: 하위 호환 유지, API 변경
  - 메이저: 호환성 깨지는 큰 변경
- 일관성 유지가 핵심임 일부는 4단계 버전(알파/릴리스 구분) 활용.

### 6.2 릴리스
- 쿠버네티스 자체에 릴리스 컨트롤러 없음 → `metadata.labels`에 릴리스 정보 추가.
- 헬름: 릴리스 이력 관리 가능, CD 파이프라인과 결합 용이.
- 네이밍 규칙(stable, canary 등) 활용 → 서비스 메시 라우팅 등 운영에 유리.
- 레이블과 셀렉터:
  - 자유로운 키/값 조합 가능.
  - 셀렉터는 생성 후 변경 불가 → 변경 시 새 ReplicaSet 생성.

### 6.3 롤아웃
- 과거: `kubectl rolling-update` 사용, 선언형 모델 어려움.
- 현재: Deployment 컨트롤러가 전략 기반 롤아웃 지원.
- 전략
  - rollingUpdate (기본)

    - 새 ReplicaSet 생성, `maxUnavailable`/`maxSurge` 값으로 점진적 교체.
    - 업데이트 이력 보관 → 롤백 가능.
  - recreate

    - 기존 파드 전면 종료 후 새 파드 생성.
    - 큐 기반 시스템 등에서 유효.

### 6.4 종합 예제
- 컨테이너 이미지 버전과 Deployment 버전 태그가 다를 수 있음.
- ConfigMap, Secret, Replica 수 변경 → 파드 스펙 버전만 바뀔 수 있음.
- 릴리스/레이블 변경 → 새 ReplicaSet 생성, 시스템 동작에 영향.

### 6.5 모범 사례
- 시맨틱 버저닝: 컨테이너 버전과 전체 애플리케이션 버전을 독립 관리.
- 메타데이터 관리: Deployment의 릴리스 네임·버전 레이블 → CI/CD 릴리스와 매칭해 추적·롤백 가능.
- 헬름 패키징: 함께 업그레이드/롤백할 서비스는 동일 차트에 묶기.

  - 헬름 훅으로 순서 제어, DB 백업/정리 등 처리.
- 네이밍 규칙: stable, canary, alpha 등 조직의 운영 속도에 맞춰 정의.